
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>shell中实现文件锁 - 游响云停</title>
	<meta name="author" content="Rangochan">

	
	<meta name="description" content="Shell中实现文件锁 Apr 13th, 2014 1.背景 当多个进程可能会对同样的数据执行操作时，这些进程需要保证其它进程没有在操作，以免损坏数据。通常，这样的进程会使用一个“锁文件”，也就是建立一个文件来告诉别的进程自己在运行，如果检测到那个文件存在则认为有操作同样数据的进程在工作。 &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="游响云停" type="application/atom+xml">
	
	<link rel="canonical" href="http://rangochan.github.com/blog/2014/04/13/shellzhong-shi-xian-wen-jian-suo/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
	<!-- Facebook Open Graph
     Facebook Debugger: https://developers.facebook.com/tools/debug -->
<meta property="og:title" content="shell中实现文件锁" /><meta itemprop="name" content="shell中实现文件锁" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://rangochan.github.com/blog/2014/04/13/shellzhong-shi-xian-wen-jian-suo/" />
<meta property="og:description" content="Shell中实现文件锁 Apr 13th, 2014 1.背景 当多个进程可能会对同样的数据执行操作时，这些进程需要保证其它进程没有在操作，以免损坏数据。通常，这样的进程会使用一个“锁文件”，也就是建立一个文件来告诉别的进程自己在运行，如果检测到那个文件存在则认为有操作同样数据的进程在工作。 &hellip;" />

<meta property="og:site_name" content="http://rangochan.github.com" />
<meta property="article:author" content="https://plus.google.com/114787528537231301324">
<meta property="article:published_time" content="2014-04-13 21:19:21 +0800" />

<meta property="article:section" content="shell/python" />
<meta itemprop="description" content="Shell中实现文件锁 Apr 13th, 2014 1.背景 当多个进程可能会对同样的数据执行操作时，这些进程需要保证其它进程没有在操作，以免损坏数据。通常，这样的进程会使用一个“锁文件”，也就是建立一个文件来告诉别的进程自己在运行，如果检测到那个文件存在则认为有操作同样数据的进程在工作。 &hellip;" />

<!-- Combine multiple fonts into one request -->
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic|Patua+One|Yanone+Kaffeesatz" rel="stylesheet" type="text/css">
<!-- jQuery -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><nav id="main-nav"><ul class="main-navigation">
  <li><a href="/"><i class="icon-home"></i>Home</a></li>
  <li><a href="/blog/archives"><i class="icon-book-alt"></i>Archives</a><span class="divider"></span></li>
  <li><a href="/about"><i class="icon-user"></i>About</a><span class="divider"></span></li>
</ul>
</nav>
<!-- <nav id="sub-nav">
	<div class="social">
		
		
		
		
		<a class="github" href="https://github.com/rangochan" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav> -->
<div class="profile-container">
  <div class="profilepic">
    <script src="/javascripts/md5.js"></script>
    <script type="text/javascript">
$(function(){
  $('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
});
    </script>
  </div>
  <hgroup>
  <h1 class="site-title"><a href="/">游响云停</a></h1>
  
  <p class="site-subtitle">运维相关技术博客</p>
  
  </hgroup>
  <hgroup>
  <h1><a href="/">游响云停</a></h1>
  
    <h2>运维相关技术博客</h2>
  
</hgroup>

</div>
</header>
			</div>
		</div>
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="article-inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  
	<h1 class="title" itemprop="name">Shell中实现文件锁</h1>
  








  



  <div class="post-date"><time datetime="2014-04-13T21:19:21+08:00" data-updated="true" itemprop="datePublished">Apr 13<span>th</span>, 2014</time></div>
	<div class="entry-content" itemprop="articleBody"><p>1.背景</p>

<p>当多个进程可能会对同样的数据执行操作时，这些进程需要保证其它进程没有在操作，以免损坏数据。通常，这样的进程会使用一个“锁文件”，也就是建立一个文件来告诉别的进程自己在运行，如果检测到那个文件存在则认为有操作同样数据的进程在工作。这样的问题是，进程不小心意外死亡了，没有清理掉那个锁文件，那么只能由用户手动来清理了。</p>

<p>2.关于flock</p>

<p>flock 是对于整个文件的建议性锁。也就是说，如果一个进程在一个文件（inode）上放了锁，那么其它进程是可以知道的。（建议性锁不强求进程遵守。）最棒的一点是，它的第一个参数是文件描述符，在此文件描述符关闭时，锁会自动释放。而当进程终止时，所有的文件描述符均会被关闭。</p>

<ol>
<li>shell中实现flock系统调用的命令是flock，其使用格式有以下两种（man flock）</li>
</ol>


<p>flock [-sxon] [-w timeout] lockfile [-c] command&hellip;
flock [-sxun] [-w timeout] fd</p>

<p>选项和参数：</p>

<p>-s,&mdash;shared：获取一个共享锁，在定向为某文件的FD上设置共享锁而未释放锁的时间内，其他进程试图在定向为此文件的FD上设置独占锁的请求失败，而其他进程试图在定向为此文件的FD上设置共享锁的请求会成功。</p>

<p>-x，-e，&mdash;exclusive：获取一个排它锁，或者称为写入锁，为默认项</p>

<p>-u，&mdash;unlock：手动释放锁，一般情况不必须，当FD关闭时，系统会自动解锁，此参数用于脚本命令一部分需要异步执行，一部分可以同步执行的情况。</p>

<p>-n，&mdash;nb, &mdash;nonblock：非阻塞模式，当获取锁失败时，返回1而不是等待</p>

<p>-w, &mdash;wait, &mdash;timeout seconds：设置阻塞超时，当超过设置的秒数时，退出阻塞模式，返回1，并继续执行后面的语句</p>

<p>-o, &mdash;close：表示当执行command前关闭设置锁的FD，以使command的子进程不保持锁。</p>

<p>-c, &mdash;command command：在shell中执行其后的语句</p>

<ol>
<li>shell中实现排它锁避免脚本重复执行</li>
</ol>


<p>Linux中的例行性工作排程crontab会定时执行一些脚本，但脚本的执行时间往往无法控制，当脚本执行时间过长时，可能会导致上一次任务的脚本还没执行完，下一次任务的脚本又开始执行了。这种情况下可能会出现一些并发问题，严重时会导致出现脏数据/性能瓶颈的恶性循环。</p>

<p>通过使用flock建立排它锁可以规避这个问题，如果一个进程对某个加了排他锁，则其它进程无法加锁，可以选择等待超时或马上返回。测试实例如下：</p>

<p>4.1 创建执行脚本</p>

<h1>cat /scripts/shell/file_lock.sh</h1>

<h1>!/bin/bash</h1>

<h1>Description: test for file flock</h1>

<p>PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:~/bin
export PATH</p>

<p>echo &ldquo;&rdquo;
echo &ldquo;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;&rdquo;</p>

<p>echo &ldquo;start at <code>date '+%Y-%m-%d %H:%M:%S'</code> &hellip;&rdquo;</p>

<p>sleep 140s</p>

<p>echo &ldquo;finished at <code>date '+%Y-%m-%d %H:%M:%S'</code> &hellip;&rdquo;</p>

<p>4.2 创建定时任务：测试排它锁</p>

<h1>crontab -e</h1>

<ul>
<li><ul>
<li><ul>
<li><ul>
<li><ul>
<li>flock -xn /dev/shm/test.lock -c &ldquo;sh /scripts/shell/file_lock.sh > /root/stdout.log&rdquo;</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


<p>每分钟执行一次该脚本，并将输出信息写入到stdout.log</p>

<p>查看输出日志如下：</p>

<hr />

<p>start at 2014-04-10 10:23:01 &hellip;            #获取锁</p>

<p>finish at 2014-04-10 10:25:21 &hellip;           #释放锁</p>

<hr />

<p>start at 2014-04-10 10:26:01 &hellip;            #10:27:00及10:28:00启动的定时任务由于无法获取锁，以失败而退出执行，直到10:26:00才获取到锁</p>

<p>finish at 2014-04-10 10:28:21 &hellip;</p>

<p>4.3 测试排它锁，加上等待超时</p>

<ul>
<li><ul>
<li><ul>
<li><ul>
<li><ul>
<li>flock -x -w 20 /dev/shm/test.lock -c &ldquo;sh /scripts/shell/file_lock.sh > /root/stdout.log&rdquo;</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>


<p>查看日志输出信息：</p>

<hr />

<p>start at 2014-04-10 10:29:01 &hellip;</p>

<p>finish at 2014-04-10 10:31:21 &hellip;</p>

<hr />

<p>start at 2014-04-10 10:31:21 &hellip;    #10:31:00启动的定时任务等待了20秒后，上一个任务释放了锁，所以此任务可以马上拿到锁，并继续执行</p>

<p>finish at 2014-04-10 10:33:41 &hellip;</p>
</div>

</article>

	<div class="share">
	<div class="share_icon_group addthis_toolbox addthis_default_style addthis_32x32_style">
	
	
	
	<a class="share_icon addthis_button_preferred_4"></a>
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/300/addthis_widget.js#pubid="></script>
</div>





  <section>
    <h1>Comments</h1>
    <div id="comments" aria-live="polite"> <!-- Duoshuo Comment BEGIN -->
<div class="ds-thread"></div>
<script type="text/javascript">
  var duoshuoQuery = {short_name:"rangochan"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = 'http://static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script>
<!-- Duoshuo Comment END -->
 </div>
  </section>

</div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright &copy; 2014 - Rangochan<span class="theme-version">Dropbot 0.8</span>
  <section class="contruction-wrap">
    <div class="contruction"></div>
  </section>
</p>

<p>Theme: <a href="https://github.com/qingwang/octopress-theme-yinyang">YinYang</a></p>
</footer>
			<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






<!--














                                            IIIIIIIIII       I
                  II                     IIIIIIIIIIIIIIIIIIII
                  IIII                  IIIIIIIIIIIIIIIIIIII
                  IIIIII                IIIIIIIIIIIIIIIIII III
                  IIIIIIII             IIIIIIIIIIIIIIIIIIIIII
                  IIIIIIIIIII          IIIIIIIIIIIIIIIIIIIII
                  IIIIIIIIIIIIII       IIIIIIIIIIIIIIIIIII
                   IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                  I  IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                  IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                  IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                   IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                    IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                     IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                         IIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                     IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                      IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII
                        IIIIIIIIIIIIIIIIIIIIIIIIIIIII
                           IIIIIIIIIIIIIIIIIIIIIIIII
                             IIIIIIIIIIIIIIIIIIIII
                          IIIIIIIIIIIIIIIIIIIIIII
                I   IIIIIIIIIIIIIIIIIIIIIIIIII
                  IIIIIIIIIIIIIIIIIIIIIIIIII
                      IIIIIIIIIIIIIIIIII















 -->

		</div>
	</div>
</body>
</html>
